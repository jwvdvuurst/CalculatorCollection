<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="/favicon.ico">
	<link rel="icon" type="image/png" href="/favicon.png">
	<title>My Collection - Calculator Collector</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 0;
			padding: 0;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
		}
		.navbar {
			background: white;
			padding: 15px 30px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.navbar a {
			color: #667eea;
			text-decoration: none;
			margin: 0 15px;
			font-weight: 500;
		}
		.navbar a:hover {
			color: #5568d3;
		}
		.container {
			max-width: 1200px;
			margin: 30px auto;
			padding: 0 20px;
		}
		.header-section {
			background: white;
			border-radius: 10px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.calculator-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		.calculator-card {
			background: white;
			border-radius: 10px;
			padding: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			transition: transform 0.2s, box-shadow 0.2s;
		}
		.calculator-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
		}
		.calculator-card h3 {
			margin: 0 0 10px 0;
			color: #333;
		}
		.calculator-card .manufacturer {
			color: #667eea;
			font-weight: 500;
			margin-bottom: 10px;
		}
		.calculator-card .details {
			color: #666;
			font-size: 0.9em;
			margin: 5px 0;
		}
		.calculator-card .added-date {
			color: #999;
			font-size: 0.8em;
			margin-top: 10px;
		}
		.calculator-card .actions {
			margin-top: 15px;
		}
		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 0.9em;
			text-decoration: none;
			display: inline-block;
		}
		.btn-primary {
			background: #667eea;
			color: white;
		}
		.btn-primary:hover {
			background: #5568d3;
		}
		.btn-danger {
			background: #e74c3c;
			color: white;
		}
		.btn-danger:hover {
			background: #c0392b;
		}
		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 10px;
			margin-top: 30px;
		}
		.pagination a, .pagination span {
			padding: 10px 15px;
			background: white;
			border-radius: 5px;
			text-decoration: none;
			color: #667eea;
			font-weight: 500;
		}
		.pagination span {
			background: #667eea;
			color: white;
		}
		.alert {
			padding: 15px;
			border-radius: 5px;
			margin-bottom: 20px;
		}
		.alert-success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}
		.alert-error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}
		.empty-state {
			background: white;
			border-radius: 10px;
			padding: 40px;
			text-align: center;
			color: #666;
		}
		.tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
		}
		.tab {
			padding: 10px 20px;
			background: white;
			border: none;
			border-radius: 5px 5px 0 0;
			cursor: pointer;
			font-size: 1em;
			color: #667eea;
			font-weight: 500;
		}
		.tab.active {
			background: #667eea;
			color: white;
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
		}
		.stats-section {
			background: white;
			border-radius: 10px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-top: 20px;
		}
		.stat-card {
			background: #f5f5f5;
			border-radius: 5px;
			padding: 15px;
		}
		.stat-card h3 {
			margin: 0 0 10px 0;
			color: #333;
			font-size: 1.1em;
		}
		.stat-item {
			display: flex;
			justify-content: space-between;
			padding: 5px 0;
			border-bottom: 1px solid #ddd;
		}
		.stat-item:last-child {
			border-bottom: none;
		}
		.stat-value {
			font-weight: bold;
			color: #667eea;
		}
	</style>
</head>
<body>
	<div class="navbar">
		<div>
			<a href="/welcome">Home</a>
			<a href="/calculators">Browse Calculators</a>
			<a href="/calculators/manufacturers">Manufacturers</a>
			<sec:authorize="isAuthenticated()">
				<a href="/calculators/collection">My Collection</a>
				<a href="/calculators/wishlist">My Wishlist</a>
			</sec:authorize>
		</div>
		<div>
			<sec:authorize="isAuthenticated()">
				<a href="/profile">My Profile</a>
				<span style="margin-left: 15px;">Hello, <strong sec:authentication="name"></strong>!</span>
				<a href="/logout" style="margin-left: 15px;">Logout</a>
			</sec:authorize>
			<sec:authorize="!isAuthenticated()">
				<a href="/login">Login</a>
			</sec:authorize>
		</div>
	</div>

	<div class="container">
		<div class="header-section">
			<h2>My Calculator Collection</h2>
			<p th:text="'Total calculators in collection: ' + ${collectionCount}">Total: 0</p>
			<div style="margin-top: 15px; display: flex; gap: 10px;">
				<a th:href="@{/calculators/collection/export(format='json')}" class="btn btn-primary">Export as JSON</a>
				<a th:href="@{/calculators/collection/export(format='csv')}" class="btn btn-primary">Export as CSV</a>
				<a th:href="@{/calculators/collection/share}" class="btn btn-primary">Share Collection</a>
				<form th:if="${emailServiceAvailable}" th:action="@{/calculators/collection/send-summary-email}" method="post" style="display: inline;">
					<button type="submit" class="btn btn-primary" style="background: #28a745;">Send Collection Summary Email</button>
				</form>
			</div>
			<div style="margin-top: 10px;">
				<form th:action="@{/calculators/collection/import}" method="post" enctype="multipart/form-data" style="display: inline;">
					<input type="file" name="file" accept=".json" required style="display: inline;">
					<button type="submit" class="btn" style="background: #28a745; color: white;">Import Collection</button>
				</form>
			</div>
		</div>

		<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
		<div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

		<div th:if="${collectionCount > 0}" class="tabs">
			<button class="tab active" onclick="showTab('collection')">Collection</button>
			<button class="tab" onclick="showTab('statistics')">Statistics</button>
		</div>

		<div id="collection-tab" class="tab-content active">
		<div th:if="${collection != null && !collection.isEmpty()}">
			<div class="calculator-grid">
				<div th:each="item : ${collection.content}" class="calculator-card">
					<h3 th:text="${item.calculator.model}">Model</h3>
					<div class="manufacturer" th:text="${item.calculator.manufacturer.name}">Manufacturer</div>
					<div class="details" th:if="${item.calculator.soldFrom != null}">
						<strong>Years:</strong> <span th:text="${item.calculator.soldFrom}"></span>
						<span th:if="${item.calculator.soldTo != null}" th:text="' - ' + ${item.calculator.soldTo}"></span>
					</div>
					<div class="added-date" th:text="'Added: ' + ${#temporals.format(item.addedAt, 'yyyy-MM-dd HH:mm')}">Added date</div>
					
					<!-- Notes Section -->
					<div class="notes-section" style="margin: 15px 0;">
						<div class="notes-display" th:id="'notes-display-' + ${item.calculator.id}">
							<div th:if="${item.notes != null && !item.notes.isEmpty()}" 
								 style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px; font-size: 0.9em; color: #555;">
								<strong>Notes:</strong>
								<div th:text="${item.notes}">Notes text</div>
							</div>
							<button type="button" class="btn" 
									style="background: #28a745; color: white; font-size: 0.8em; padding: 5px 10px;"
									th:onclick="'editNotes(' + ${item.calculator.id} + ')'">
								<span th:text="${item.notes != null && !item.notes.isEmpty()} ? 'Edit Notes' : 'Add Notes'">Add Notes</span>
							</button>
						</div>
						<div class="notes-edit hidden" th:id="'notes-edit-' + ${item.calculator.id}">
							<form th:action="@{/calculators/collection/{id}/notes(id=${item.calculator.id})}" method="post">
								<textarea name="notes" 
										  style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; font-size: 0.9em;"
										  th:text="${item.notes}">Notes</textarea>
								<div style="margin-top: 5px; display: flex; gap: 5px;">
									<button type="submit" class="btn" style="background: #667eea; color: white; font-size: 0.8em; padding: 5px 10px;">Save</button>
									<button type="button" class="btn" style="background: #6c757d; color: white; font-size: 0.8em; padding: 5px 10px;"
											th:onclick="'cancelEditNotes(' + ${item.calculator.id} + ')'">Cancel</button>
								</div>
							</form>
						</div>
					</div>
					
					<div class="actions">
						<a th:href="@{/calculators/{id}(id=${item.calculator.id})}" class="btn btn-primary" style="margin-bottom: 10px; display: block; text-align: center;">View Details</a>
						<form th:action="@{/calculators/collection/remove/{id}(id=${item.calculator.id}, redirectTo='collection')}" method="post">
							<button type="submit" class="btn btn-danger" style="width: 100%;">Remove from Collection</button>
						</form>
					</div>
				</div>
			</div>

			<div class="pagination" th:if="${collection.totalPages > 1}">
				<a th:if="${collection.hasPrevious()}" 
				   th:href="@{/calculators/collection(page=${collection.number - 1})}">Previous</a>
				<span th:text="'Page ' + (${collection.number} + 1) + ' of ' + ${collection.totalPages}"></span>
				<a th:if="${collection.hasNext()}" 
				   th:href="@{/calculators/collection(page=${collection.number + 1})}">Next</a>
			</div>
		</div>

		<div th:if="${collection == null || collection.isEmpty()}" class="empty-state">
			<h3>Your collection is empty</h3>
			<p>Start building your collection by browsing calculators and adding them to your collection!</p>
			<a href="/calculators" class="btn" style="margin-top: 20px; background: #667eea; color: white;">Browse Calculators</a>
		</div>
		</div>

		<div id="statistics-tab" class="tab-content" th:if="${statistics != null}">
			<div class="stats-section">
				<h2>Collection Statistics</h2>
				
				<div class="stats-grid">
					<div class="stat-card" th:if="${statistics.byManufacturer != null && !statistics.byManufacturer.isEmpty()}">
						<h3>By Manufacturer</h3>
						<div th:each="entry : ${statistics.byManufacturer}">
							<div class="stat-item">
								<span th:text="${entry.key}">Manufacturer</span>
								<span class="stat-value" th:text="${entry.value}">0</span>
							</div>
						</div>
					</div>

					<div class="stat-card" th:if="${statistics.byPeriod != null && !statistics.byPeriod.isEmpty()}">
						<h3>By Time Period</h3>
						<div th:each="entry : ${statistics.byPeriod}">
							<div class="stat-item">
								<span th:text="${entry.key}">Period</span>
								<span class="stat-value" th:text="${entry.value}">0</span>
							</div>
						</div>
					</div>

					<div class="stat-card" th:if="${statistics.byLabel != null && !statistics.byLabel.isEmpty()}">
						<h3>By Label</h3>
						<div th:each="entry : ${statistics.byLabel}">
							<div class="stat-item">
								<span th:text="${entry.key}">Label</span>
								<span class="stat-value" th:text="${entry.value}">0</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		function showTab(tabName) {
			// Hide all tabs
			document.querySelectorAll('.tab-content').forEach(tab => {
				tab.classList.remove('active');
			});
			document.querySelectorAll('.tab').forEach(tab => {
				tab.classList.remove('active');
			});

			// Show selected tab
			document.getElementById(tabName + '-tab').classList.add('active');
			event.target.classList.add('active');
		}
		
		function editNotes(calculatorId) {
			const display = document.getElementById('notes-display-' + calculatorId);
			const edit = document.getElementById('notes-edit-' + calculatorId);
			display.classList.add('hidden');
			edit.classList.remove('hidden');
		}
		
		function cancelEditNotes(calculatorId) {
			const display = document.getElementById('notes-display-' + calculatorId);
			const edit = document.getElementById('notes-edit-' + calculatorId);
			display.classList.remove('hidden');
			edit.classList.add('hidden');
		}
	</script>
</body>
</html>

