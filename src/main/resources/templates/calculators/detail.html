<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title th:text="${calculator.model} + ' - Calculator Collector'">Calculator Detail</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 0;
			padding: 0;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
		}
		.navbar {
			background: white;
			padding: 15px 30px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.navbar a {
			color: #667eea;
			text-decoration: none;
			margin: 0 15px;
			font-weight: 500;
		}
		.container {
			max-width: 1200px;
			margin: 30px auto;
			padding: 0 20px;
		}
		.calculator-detail {
			background: white;
			border-radius: 10px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.calculator-detail h1 {
			margin-top: 0;
			color: #333;
		}
		.calculator-detail .manufacturer {
			color: #667eea;
			font-size: 1.2em;
			font-weight: 500;
			margin-bottom: 15px;
		}
		.calculator-detail .details {
			color: #666;
			margin: 10px 0;
		}
		.image-section {
			background: white;
			border-radius: 10px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.image-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			gap: 20px;
			margin: 20px 0;
		}
		.image-item {
			position: relative;
			border-radius: 5px;
			overflow: hidden;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}
		.image-item img {
			width: 100%;
			height: 200px;
			object-fit: cover;
		}
		.image-item .delete-btn {
			position: absolute;
			top: 5px;
			right: 5px;
			background: rgba(231, 76, 60, 0.9);
			color: white;
			border: none;
			padding: 5px 10px;
			border-radius: 3px;
			cursor: pointer;
			font-size: 0.8em;
		}
		.image-item .status-badge {
			position: absolute;
			bottom: 5px;
			left: 5px;
			background: rgba(255, 193, 7, 0.9);
			color: #333;
			padding: 3px 8px;
			border-radius: 3px;
			font-size: 0.7em;
			font-weight: bold;
		}
		.upload-form {
			background: #f5f5f5;
			border-radius: 5px;
			padding: 20px;
			margin-top: 20px;
		}
		.upload-form input[type="file"] {
			margin: 10px 0;
		}
		.upload-form .checkbox-group {
			margin: 15px 0;
		}
		.upload-form .checkbox-group label {
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.btn {
			padding: 10px 20px;
			background: #667eea;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 1em;
			text-decoration: none;
			display: inline-block;
		}
		.btn:hover {
			background: #5568d3;
		}
		.alert {
			padding: 15px;
			border-radius: 5px;
			margin-bottom: 20px;
		}
		.alert-success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}
		.alert-error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}
	</style>
</head>
<body>
	<div class="navbar">
		<div>
			<a href="/welcome">Home</a>
			<a href="/calculators">Browse Calculators</a>
			<a href="/calculators/manufacturers">Manufacturers</a>
			<sec:authorize="isAuthenticated()">
				<a href="/calculators/collection">My Collection</a>
			</sec:authorize>
			<sec:authorize="hasRole('ADMIN')">
				<a href="/admin/dashboard">Admin</a>
			</sec:authorize>
		</div>
		<div>
			<sec:authorize="isAuthenticated()">
				<a href="/profile">My Profile</a>
				<span style="margin-left: 15px;">Hello, <strong sec:authentication="name"></strong>!</span>
				<a href="/logout" style="margin-left: 15px;">Logout</a>
			</sec:authorize>
			<sec:authorize="!isAuthenticated()">
				<a href="/login">Login</a>
			</sec:authorize>
		</div>
	</div>

	<div class="container">
		<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
		<div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

		<div class="calculator-detail" th:if="${calculator}">
			<h1 th:text="${calculator.model}">Calculator Model</h1>
			<div class="manufacturer" th:text="${calculator.manufacturer.name}">Manufacturer</div>
			<div class="details" th:if="${calculator.soldFrom != null}">
				<strong>Years:</strong> <span th:text="${calculator.soldFrom}"></span>
				<span th:if="${calculator.soldTo != null}" th:text="' - ' + ${calculator.soldTo}"></span>
			</div>
			<div class="details" th:if="${calculator.sourceUrl}">
				<strong>Source:</strong> <a th:href="${calculator.sourceUrl}" target="_blank" th:text="${calculator.sourceUrl}"></a>
			</div>
		</div>

		<div class="image-section">
			<h2>Images</h2>
			
			<div th:if="${images != null && !images.isEmpty()}" class="image-grid">
				<div th:each="image : ${images}" class="image-item">
					<img th:src="@{'/uploads/' + ${image.imagePath}}" alt="Calculator image" 
						 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' dy=\'10.5\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';">
					<div th:if="${image.isProposal && !image.isApproved}" class="status-badge">Pending Approval</div>
					<sec:authorize="isAuthenticated()">
						<form th:action="@{/calculators/images/{id}/delete(id=${image.id}, calculatorId=${calculator.id})}" 
							  method="post" style="display: inline;"
							  th:if="${image.uploadedBy == username || !image.isApproved}">
							<button type="submit" class="delete-btn" onclick="return confirm('Delete this image?')">Delete</button>
						</form>
					</sec:authorize>
				</div>
			</div>
			<div th:if="${images == null || images.isEmpty()}">
				<p style="color: #666;">No images available for this calculator.</p>
			</div>

			<sec:authorize="isAuthenticated()">
				<div class="upload-form">
					<h3>Upload Image</h3>
					<form th:action="@{/calculators/{id}/images(id=${calculator.id})}" method="post" enctype="multipart/form-data">
						<input type="file" name="file" accept="image/*" required>
						<div class="checkbox-group">
							<label>
								<input type="checkbox" name="proposeForRepository" value="true">
								<span>Propose this image for the central repository (requires admin approval)</span>
							</label>
						</div>
						<button type="submit" class="btn">Upload Image</button>
					</form>
				</div>
			</sec:authorize>
		</div>

		<div class="image-section">
			<h2>Labels</h2>
			<div th:if="${labels != null && !labels.isEmpty()}" style="margin: 20px 0;">
				<div style="display: flex; flex-wrap: wrap; gap: 10px;">
					<span th:each="label : ${labels}" 
						  style="background: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em;">
						<span th:text="${label.name}">Label</span>
						<sec:authorize="isAuthenticated()">
							<form th:action="@{/calculators/{id}/labels/{labelId}/remove(id=${calculator.id}, labelId=${label.id})}" 
								  method="post" style="display: inline; margin-left: 5px;">
								<button type="submit" style="background: rgba(255,255,255,0.3); border: none; color: white; cursor: pointer; border-radius: 50%; width: 18px; height: 18px; font-size: 0.8em;" 
										onclick="return confirm('Remove this label?')">Ã—</button>
							</form>
						</sec:authorize>
					</span>
				</div>
			</div>
			<div th:if="${labels == null || labels.isEmpty()}">
				<p style="color: #666;">No labels assigned to this calculator.</p>
			</div>

			<sec:authorize="isAuthenticated()">
				<div class="upload-form">
					<h3>Add Label</h3>
					<form th:action="@{/calculators/{id}/labels(id=${calculator.id})}" method="post">
						<div style="margin-bottom: 10px;">
							<label>Select curated label:</label>
							<select name="labelId" style="width: 100%; padding: 8px; margin-top: 5px;">
								<option value="">-- Select a curated label --</option>
								<option th:each="label : ${curatedLabels}" 
										th:value="${label.id}" 
										th:text="${label.name} + (${label.description != null ? ' - ' + label.description : ''})">
								</option>
							</select>
						</div>
						<div style="margin: 15px 0; text-align: center; color: #666;">OR</div>
						<div style="margin-bottom: 10px;">
							<label>Create new free-form label:</label>
							<input type="text" name="newLabelName" placeholder="Enter label name" 
								   style="width: 100%; padding: 8px; margin-top: 5px;">
						</div>
						<button type="submit" class="btn">Add Label</button>
					</form>
				</div>
			</sec:authorize>
		</div>

		<div class="image-section">
			<h2>External Links</h2>
			<div th:if="${links != null && !links.isEmpty()}" style="margin: 20px 0;">
				<div style="display: flex; flex-direction: column; gap: 10px;">
					<div th:each="link : ${links}" 
						 style="background: #f5f5f5; padding: 15px; border-radius: 5px; border-left: 4px solid #667eea;">
						<a th:href="${link.url}" target="_blank" 
						   style="color: #667eea; font-weight: 500; font-size: 1.1em; text-decoration: none;"
						   th:text="${link.title}">Link Title</a>
						<p th:if="${link.description != null}" 
						   style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;" 
						   th:text="${link.description}">Description</p>
						<div style="margin-top: 5px; font-size: 0.8em; color: #999;">
							Added by <span th:text="${link.addedBy}"></span> on 
							<span th:text="${#temporals.format(link.addedAt, 'yyyy-MM-dd')}"></span>
							<sec:authorize="isAuthenticated()">
								<form th:action="@{/calculators/links/{id}/delete(id=${link.id}, calculatorId=${calculator.id})}" 
									  method="post" style="display: inline; margin-left: 10px;"
									  th:if="${link.addedBy == username}">
									<button type="submit" style="background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;"
											onclick="return confirm('Delete this link?')">Delete</button>
								</form>
							</sec:authorize>
						</div>
					</div>
				</div>
			</div>
			<div th:if="${links == null || links.isEmpty()}">
				<p style="color: #666;">No external links added for this calculator.</p>
			</div>

			<sec:authorize="isAuthenticated()">
				<div class="upload-form">
					<h3>Add Link</h3>
					<form th:action="@{/calculators/{id}/links(id=${calculator.id})}" method="post">
						<div style="margin-bottom: 10px;">
							<label>URL:</label>
							<input type="url" name="url" required 
								   placeholder="https://example.com" 
								   style="width: 100%; padding: 8px; margin-top: 5px;">
						</div>
						<div style="margin-bottom: 10px;">
							<label>Title:</label>
							<input type="text" name="title" required 
								   placeholder="Link title" 
								   style="width: 100%; padding: 8px; margin-top: 5px;">
						</div>
						<div style="margin-bottom: 10px;">
							<label>Description (optional):</label>
							<textarea name="description" rows="2" 
									  placeholder="Brief description of the link" 
									  style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
						</div>
						<button type="submit" class="btn">Add Link</button>
					</form>
				</div>
			</sec:authorize>
		</div>
	</div>
</body>
</html>

