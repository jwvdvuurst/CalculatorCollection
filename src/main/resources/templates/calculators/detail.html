<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="/favicon.ico">
	<link rel="icon" type="image/png" href="/favicon.png">
	<title th:text="${calculator.model} + ' - Calculator Collector'">Calculator Detail</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 0;
			padding: 0;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
		}
		.navbar {
			background: white;
			padding: 15px 30px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.navbar a {
			color: #667eea;
			text-decoration: none;
			margin: 0 15px;
			font-weight: 500;
		}
		.container {
			max-width: 1200px;
			margin: 30px auto;
			padding: 0 20px;
		}
		.calculator-detail {
			background: white;
			border-radius: 10px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.calculator-detail h1 {
			margin-top: 0;
			color: #333;
		}
		.calculator-detail .manufacturer {
			color: #667eea;
			font-size: 1.2em;
			font-weight: 500;
			margin-bottom: 15px;
		}
		.calculator-detail .details {
			color: #666;
			margin: 10px 0;
		}
		.image-section {
			background: white;
			border-radius: 10px;
			padding: 30px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		.image-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			gap: 20px;
			margin: 20px 0;
		}
		.image-item {
			position: relative;
			border-radius: 5px;
			overflow: hidden;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}
		.image-item img {
			width: 100%;
			height: 200px;
			object-fit: cover;
		}
		.image-item .delete-btn {
			position: absolute;
			top: 5px;
			right: 5px;
			background: rgba(231, 76, 60, 0.9);
			color: white;
			border: none;
			padding: 5px 10px;
			border-radius: 3px;
			cursor: pointer;
			font-size: 0.8em;
		}
		.image-item .status-badge {
			position: absolute;
			bottom: 5px;
			left: 5px;
			background: rgba(255, 193, 7, 0.9);
			color: #333;
			padding: 3px 8px;
			border-radius: 3px;
			font-size: 0.7em;
			font-weight: bold;
		}
		.upload-form {
			background: #f5f5f5;
			border-radius: 5px;
			padding: 20px;
			margin-top: 20px;
		}
		.upload-form input[type="file"] {
			margin: 10px 0;
		}
		.upload-form .checkbox-group {
			margin: 15px 0;
		}
		.upload-form .checkbox-group label {
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.btn {
			padding: 10px 20px;
			background: #667eea;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 1em;
			text-decoration: none;
			display: inline-block;
		}
		.btn:hover {
			background: #5568d3;
		}
		.alert {
			padding: 15px;
			border-radius: 5px;
			margin-bottom: 20px;
		}
		.alert-success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}
		.alert-error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}
	</style>
</head>
<body>
	<div class="navbar">
		<div>
			<a href="/welcome">Home</a>
			<a href="/calculators">Browse Calculators</a>
			<a href="/calculators/manufacturers">Manufacturers</a>
			<sec:authorize="isAuthenticated()">
				<a href="/calculators/collection">My Collection</a>
			</sec:authorize>
			<sec:authorize="hasRole('ADMIN')">
				<a href="/admin/dashboard">Admin</a>
			</sec:authorize>
		</div>
		<div>
			<sec:authorize="isAuthenticated()">
				<a href="/profile">My Profile</a>
				<span style="margin-left: 15px;">Hello, <strong sec:authentication="name"></strong>!</span>
				<a href="/logout" style="margin-left: 15px;">Logout</a>
			</sec:authorize>
			<sec:authorize="!isAuthenticated()">
				<a href="/login">Login</a>
			</sec:authorize>
		</div>
	</div>

	<div class="container">
		<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
		<div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

		<div class="calculator-detail" th:if="${calculator}">
			<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
				<div style="flex: 1;">
					<h1 th:text="${calculator.model}">Calculator Model</h1>
					<div class="manufacturer" th:text="${calculator.manufacturer.name}">Manufacturer</div>
					<div class="details" th:if="${calculator.soldFrom != null}">
						<strong>Years:</strong> <span th:text="${calculator.soldFrom}"></span>
						<span th:if="${calculator.soldTo != null}" th:text="' - ' + ${calculator.soldTo}"></span>
					</div>
					<div class="details" th:if="${calculator.sourceUrl}">
						<strong>Source:</strong> <a th:href="${calculator.sourceUrl}" target="_blank" th:text="${calculator.sourceUrl}"></a>
					</div>
					<div class="details" th:if="${calculator.description != null && !calculator.description.isEmpty()}" 
						 style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #17a2b8;">
						<strong style="color: #17a2b8;">Enriched Description:</strong>
						<div style="margin-top: 10px; white-space: pre-wrap; color: #333;" th:utext="${calculator.description}"></div>
					</div>
				</div>
				<div style="display: flex; gap: 10px; flex-wrap: wrap;">
					<sec:authorize="isAuthenticated()">
						<form th:action="@{/calculators/collection/add/{id}(id=${calculator.id}, redirectTo='detail')}" method="post" style="display: inline;"
							  th:if="${inCollection == null || !inCollection}">
							<button type="submit" class="btn" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
								‚ûï Add to Collection
							</button>
						</form>
						<form th:action="@{/calculators/collection/remove/{id}(id=${calculator.id}, redirectTo='detail')}" method="post" style="display: inline;"
							  th:if="${inCollection != null && inCollection}">
							<button type="submit" class="btn" style="background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
								‚ûñ Remove from Collection
							</button>
						</form>
						<form th:action="@{/calculators/wishlist/add/{id}(id=${calculator.id}, redirectTo='detail')}" method="post" style="display: inline;"
							  th:if="${inWishlist == null || !inWishlist}">
							<button type="submit" class="btn" style="background: #f39c12; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
								‚≠ê Add to Wishlist
							</button>
						</form>
						<form th:action="@{/calculators/wishlist/remove/{id}(id=${calculator.id}, redirectTo='detail')}" method="post" style="display: inline;"
							  th:if="${inWishlist != null && inWishlist}">
							<button type="submit" class="btn" style="background: #e67e22; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
								‚≠ê Remove from Wishlist
							</button>
						</form>
					</sec:authorize>
					<sec:authorize="hasRole('ADMIN')">
						<a th:href="@{/admin/calculators/edit/{id}(id=${calculator.id})}" 
						   class="btn" 
						   style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
							‚úèÔ∏è Edit Calculator
						</a>
					</sec:authorize>
					<sec:authorize="isAuthenticated()">
						<a th:href="@{/calculators/{id}/social-share(id=${calculator.id})}" 
						   class="btn" 
						   style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
							üì± Share to Social Media
						</a>
					</sec:authorize>
					<sec:authorize="hasRole('ADMIN')">
						<form th:action="@{/calculators/{id}/enrich(id=${calculator.id})}" 
							  method="post" 
							  style="display: inline;"
							  onsubmit="return confirm('This will enrich the calculator data using external APIs. Continue?');">
							<button type="submit" 
									class="btn" 
									style="background: #ffc107; color: #333; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
								‚ú® Enrich Calculator Data
							</button>
						</form>
					</sec:authorize>
				</div>
			</div>
		</div>

		<div class="image-section">
			<h2>Images</h2>
			
			<div th:if="${images != null && !images.isEmpty()}" class="image-grid">
				<div th:each="image : ${images}" class="image-item">
					<img th:src="@{'/uploads/' + ${image.imagePath}}" alt="Calculator image" 
						 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' dy=\'10.5\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';">
					<div th:if="${image.isProposal && !image.isApproved}" class="status-badge">Pending Approval</div>
					<sec:authorize="isAuthenticated()">
						<form th:action="@{/calculators/images/{id}/delete(id=${image.id}, calculatorId=${calculator.id})}" 
							  method="post" style="display: inline;"
							  th:if="${image.uploadedBy == username || !image.isApproved}">
							<button type="submit" class="delete-btn" onclick="return confirm('Delete this image?')">Delete</button>
						</form>
					</sec:authorize>
				</div>
			</div>
			<div th:if="${images == null || images.isEmpty()}">
				<p style="color: #666;">No images available for this calculator.</p>
			</div>

			<sec:authorize="isAuthenticated()">
				<div class="upload-form">
					<h3>Upload Image</h3>
					<form th:action="@{/calculators/{id}/images(id=${calculator.id})}" method="post" enctype="multipart/form-data">
						<input type="file" name="file" accept="image/*" required>
						<div class="checkbox-group">
							<label>
								<input type="checkbox" name="proposeForRepository" value="true">
								<span>Propose this image for the central repository (requires admin approval)</span>
							</label>
						</div>
						<button type="submit" class="btn">Upload Image</button>
					</form>
				</div>
			</sec:authorize>
			
			<!-- Display found images from enrichment (admin only) -->
			<sec:authorize="hasRole('ADMIN')">
				<div th:if="${foundImages != null && !foundImages.isEmpty()}" style="margin-top: 30px;">
					<h3>Found Images from Web Search</h3>
					<p style="color: #666; margin-bottom: 15px;">These images were found during enrichment. Click "Add Image" to download and add them to this calculator.</p>
					<div class="image-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
						<div th:each="foundImage : ${foundImages}" class="image-item" 
							 style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
							<img th:src="${foundImage.thumbnailUrl != null ? foundImage.thumbnailUrl : foundImage.imageUrl}" 
								 alt="Found image" 
								 style="width: 100%; height: 150px; object-fit: cover; border-radius: 3px;"
								 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'150\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'150\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'12\' dy=\'10.5\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';">
							<div style="margin-top: 8px; font-size: 0.9em;">
								<div th:if="${foundImage.title}" style="font-weight: bold; margin-bottom: 5px;" th:text="${foundImage.title}"></div>
								<div th:if="${foundImage.width != null && foundImage.height != null}" 
									 style="color: #666; font-size: 0.85em;" 
									 th:text="${foundImage.width + 'x' + foundImage.height}"></div>
								<div th:if="${foundImage.source}" style="color: #999; font-size: 0.8em;" th:text="'Source: ' + ${foundImage.source}"></div>
							</div>
							<form th:action="@{/calculators/{id}/images/from-url(id=${calculator.id})}" 
								  method="post" 
								  style="margin-top: 10px;"
								  onsubmit="return confirm('Download and add this image to the calculator?');">
								<input type="hidden" name="imageUrl" th:value="${foundImage.imageUrl}">
								<input type="hidden" name="proposeForRepository" value="false">
								<button type="submit" class="btn" 
										style="width: 100%; padding: 8px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
									‚ûï Add Image
								</button>
							</form>
						</div>
					</div>
				</div>
			</sec:authorize>
		</div>

		<div class="image-section">
			<h2>Labels</h2>
			<div th:if="${labels != null && !labels.isEmpty()}" style="margin: 20px 0;">
				<div style="display: flex; flex-wrap: wrap; gap: 10px;">
					<span th:each="label : ${labels}" 
						  style="background: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9em;">
						<span th:text="${label.name}">Label</span>
						<sec:authorize="isAuthenticated()">
							<form th:action="@{/calculators/{id}/labels/{labelId}/remove(id=${calculator.id}, labelId=${label.id})}" 
								  method="post" style="display: inline; margin-left: 5px;">
								<button type="submit" style="background: rgba(255,255,255,0.3); border: none; color: white; cursor: pointer; border-radius: 50%; width: 18px; height: 18px; font-size: 0.8em;" 
										onclick="return confirm('Remove this label?')">√ó</button>
							</form>
						</sec:authorize>
					</span>
				</div>
			</div>
			<div th:if="${labels == null || labels.isEmpty()}">
				<p style="color: #666;">No labels assigned to this calculator.</p>
			</div>

			<sec:authorize="isAuthenticated()">
				<div class="upload-form">
					<h3>Add Label</h3>
					<form th:action="@{/calculators/{id}/labels(id=${calculator.id})}" method="post">
						<div style="margin-bottom: 10px;">
							<label>Select curated label:</label>
							<select name="labelId" style="width: 100%; padding: 8px; margin-top: 5px;">
								<option value="">-- Select a curated label --</option>
								<option th:each="label : ${curatedLabels}" 
										th:value="${label.id}" 
										th:text="${label.name} + (${label.description != null ? ' - ' + label.description : ''})">
								</option>
							</select>
						</div>
						<div style="margin: 15px 0; text-align: center; color: #666;">OR</div>
						<div style="margin-bottom: 10px;">
							<label>Create new free-form label:</label>
							<input type="text" name="newLabelName" placeholder="Enter label name" 
								   style="width: 100%; padding: 8px; margin-top: 5px;">
						</div>
						<button type="submit" class="btn">Add Label</button>
					</form>
				</div>
			</sec:authorize>
		</div>

		<div class="image-section">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
				<h2 style="margin: 0;">External Links</h2>
				<sec:authorize="isAuthenticated()">
					<div th:if="${links != null && !links.isEmpty()}" style="display: flex; gap: 10px; align-items: center;">
						<button type="button" id="toggleSelectionMode" 
								style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;"
								onclick="toggleSelectionMode()">
							‚òëÔ∏è Select Links
						</button>
						<div id="selectionControls" style="display: none; gap: 10px; align-items: center; flex-direction: row;">
							<button type="button" onclick="selectAllLinks()" 
									style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
								Select All
							</button>
							<button type="button" onclick="selectNoneLinks()" 
									style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
								Select None
							</button>
							<form id="bulkDeleteForm" th:action="@{/calculators/{id}/links/bulk-delete(id=${calculator.id})}" 
								  method="post" style="display: inline;" onsubmit="return handleBulkDelete(event)">
								<button type="submit" 
										style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
									Delete Selected
								</button>
							</form>
						</div>
					</div>
				</sec:authorize>
			</div>
			<div th:if="${links != null && !links.isEmpty()}" style="margin: 20px 0;">
				<div style="display: flex; flex-direction: column; gap: 10px;">
					<div th:each="link : ${links}" 
						 class="link-item"
						 style="background: #f5f5f5; padding: 15px; border-radius: 5px; border-left: 4px solid #667eea; display: flex; align-items: start; gap: 10px;">
						<div class="link-checkbox" style="display: none; margin-top: 5px;"
							 th:if="${link.addedBy == username}">
							<input type="checkbox" name="selectedLinks" th:value="${link.id}" 
								   style="width: 18px; height: 18px; cursor: pointer;">
						</div>
						<div style="flex: 1;">
							<a th:href="${link.url}" target="_blank" 
							   style="color: #667eea; font-weight: 500; font-size: 1.1em; text-decoration: none;"
							   th:text="${link.title}">Link Title</a>
							<p th:if="${link.description != null}" 
							   style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;" 
							   th:text="${link.description}">Description</p>
							<div style="margin-top: 5px; font-size: 0.8em; color: #999;">
								Added by <span th:text="${link.addedBy}"></span> on 
								<span th:text="${#temporals.format(link.addedAt, 'yyyy-MM-dd')}"></span>
								<sec:authorize="isAuthenticated()">
									<form th:action="@{/calculators/links/{id}/delete(id=${link.id})}" 
										  method="post" style="display: inline; margin-left: 10px;"
										  class="single-delete-form"
										  th:if="${link.addedBy == username}">
										<input type="hidden" name="calculatorId" th:value="${calculator.id}">
										<button type="submit" style="background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em;"
												onclick="return confirm('Delete this link?')">Delete</button>
									</form>
								</sec:authorize>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div th:if="${links == null || links.isEmpty()}">
				<p style="color: #666;">No external links added for this calculator.</p>
			</div>

			<sec:authorize="isAuthenticated()">
				<div class="upload-form">
					<h3>Add Link</h3>
					<form th:action="@{/calculators/{id}/links(id=${calculator.id})}" method="post">
						<div style="margin-bottom: 10px;">
							<label>URL:</label>
							<input type="url" name="url" required 
								   placeholder="https://example.com" 
								   style="width: 100%; padding: 8px; margin-top: 5px;">
						</div>
						<div style="margin-bottom: 10px;">
							<label>Title:</label>
							<input type="text" name="title" required 
								   placeholder="Link title" 
								   style="width: 100%; padding: 8px; margin-top: 5px;">
						</div>
						<div style="margin-bottom: 10px;">
							<label>Description (optional):</label>
							<textarea name="description" rows="2" 
									  placeholder="Brief description of the link" 
									  style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
						</div>
						<button type="submit" class="btn">Add Link</button>
					</form>
				</div>
			</sec:authorize>
		</div>
	</div>

	<script>
		let selectionMode = false;

		function toggleSelectionMode() {
			selectionMode = !selectionMode;
			const checkboxes = document.querySelectorAll('.link-checkbox');
			const controls = document.getElementById('selectionControls');
			const toggleBtn = document.getElementById('toggleSelectionMode');
			const singleDeleteForms = document.querySelectorAll('.single-delete-form');

			if (selectionMode) {
				// Show checkboxes and controls
				checkboxes.forEach(cb => cb.style.display = 'block');
				controls.style.display = 'flex';
				toggleBtn.textContent = '‚úñÔ∏è Cancel Selection';
				toggleBtn.style.background = '#6c757d';
				// Hide individual delete buttons
				singleDeleteForms.forEach(form => form.style.display = 'none');
			} else {
				// Hide checkboxes and controls
				checkboxes.forEach(cb => cb.style.display = 'none');
				controls.style.display = 'none';
				toggleBtn.textContent = '‚òëÔ∏è Select Links';
				toggleBtn.style.background = '#667eea';
				// Show individual delete buttons
				singleDeleteForms.forEach(form => form.style.display = 'inline');
				// Uncheck all
				document.querySelectorAll('input[name="selectedLinks"]').forEach(cb => cb.checked = false);
			}
		}

		function selectAllLinks() {
			document.querySelectorAll('input[name="selectedLinks"]:not(:disabled)').forEach(cb => {
				cb.checked = true;
			});
		}

		function selectNoneLinks() {
			document.querySelectorAll('input[name="selectedLinks"]').forEach(cb => {
				cb.checked = false;
			});
		}

		function handleBulkDelete(event) {
			event.preventDefault();
			const selected = document.querySelectorAll('input[name="selectedLinks"]:checked');
			if (selected.length === 0) {
				alert('Please select at least one link to delete.');
				return false;
			}
			
			if (!confirm('Are you sure you want to delete ' + selected.length + ' selected link(s)?')) {
				return false;
			}
			
			// Collect selected link IDs
			const linkIds = Array.from(selected).map(cb => cb.value);
			
			// Get the form and clear any existing hidden inputs for selectedLinks
			const form = document.getElementById('bulkDeleteForm');
			const existingInputs = form.querySelectorAll('input[name="selectedLinks"][type="hidden"]');
			existingInputs.forEach(input => input.remove());
			
			// Add hidden inputs to the form with selected link IDs
			linkIds.forEach(linkId => {
				const input = document.createElement('input');
				input.type = 'hidden';
				input.name = 'selectedLinks';
				input.value = linkId;
				form.appendChild(input);
			});
			
			// Submit the form
			form.submit();
			return false;
		}
	</script>
</body>
</html>

